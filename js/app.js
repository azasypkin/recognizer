function addSample(e){var t=sampleIds[currentSampleIndex++],r=document.createElement("div");r.classList="sample__container",r.id=t;var n=document.createElement("img");n.classList="sample__preview",n.src=window.URL.createObjectURL(e);var o=document.createElement("button");o.type="button",o.textContent="Recognize",o.classList="sample__recognize-button action-button",o.dataset.sampleId=t,o.dataset.kind=sampleActions.RECOGNIZE;var i=document.createElement("button");i.type="button",i.textContent="Repeat text",i.classList="sample__repeat-button action-button",i.dataset.sampleId=t,i.dataset.kind=sampleActions.REPEAT,r.appendChild(n),r.appendChild(o),r.appendChild(i),samplesListComponent.appendChild(r),samples.set(t,{id:t,image:e,text:null})}function getSampleCanvas(e){var t=new Defer;return blobLoaderComponent.src=window.URL.createObjectURL(e.image),blobLoaderComponent.onload=function(){var e=blobRendererComponent.getContext("2d");e.clearRect(0,0,Number(blobRendererComponent.getAttribute("width")),Number(blobRendererComponent.getAttribute("height"))),blobRendererComponent.setAttribute("width",blobLoaderComponent.width),blobRendererComponent.setAttribute("height",blobLoaderComponent.height),e.drawImage(blobLoaderComponent,0,0,blobLoaderComponent.width,blobLoaderComponent.height),t.resolve({context:e,width:blobLoaderComponent.width,height:blobLoaderComponent.height})},blobLoaderComponent.onerror=function(e){return t.reject(e)},t.promise}function addSampleFromURL(e){return fetch(e).catch(function(t){console.warn("Can not load image directly, trying through the proxy: ",t);var r=`https://recognizer-ocr-proxy.herokuapp.com/?${e}`,n=new Headers;return n.append("Target-URL",e),fetch(r,{headers:n})}).then(function(e){return e.blob()}).then(function(e){addSample(e)}).catch(function(e){console.error("Failed to add sample from URL: ",e),alert("Failed to add sample! See log for more details...")})}function addSampleFromHash(){!location.hash||location.hash.length<2||addSampleFromURL(location.hash.slice(1).trim())}var classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),p=Object.freeze({promise:Symbol("promise"),resolve:Symbol("resolve"),reject:Symbol("reject")}),Defer=function(){function e(){var t=this;classCallCheck(this,e),this[p.promise]=new Promise(function(e,r){t[p.resolve]=e,t[p.reject]=r}),Object.freeze(this)}return e.prototype.resolve=function(e){this[p.resolve](e)},e.prototype.reject=function(e){this[p.reject](e)},createClass(e,[{key:"promise",get:function(){return this[p.promise]}}]),e}(),p$1=Object.freeze({getUserMediaOld:Symbol("getUserMediaOld")}),VideoManager=function(){function e(){classCallCheck(this,e)}return e.prototype.getMediaStream=function(){var e=arguments.length<=0||void 0===arguments[0]||arguments[0],t=!(arguments.length<=1||void 0===arguments[1])&&arguments[1];return void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=this[p$1.getUserMediaOld]),navigator.mediaDevices.getUserMedia({audio:t,video:e}).then(function(e){return console.log("[VideoManager]: Media stream is available."),e}).catch(function(e){throw console.error("[VideoManager]: Media stream is not available.",e),e})},e.prototype[p$1.getUserMediaOld]=function(e){var t=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise(function(r,n){t.call(navigator,e,r,n)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))},e}(),p$4=Object.freeze({db:Symbol("db")}),InMemoryStorage=function(){function e(){classCallCheck(this,e),this[p$4.db]=new Map}return e.prototype.getAll=function(e){var t=this[p$4.db].get(e);return Promise.resolve(t?Array.from(t.values()):[])},e.prototype.getByKey=function(e,t){var r=this[p$4.db].get(e);return r&&r.has(t)?Promise.resolve(r.get(t)):Promise.reject(new Error(`There is no item (${t}) in the store (${e}).`))},e.prototype.set=function(e,t,r){var n=this[p$4.db].get(e);return n||this[p$4.db].set(e,n=new Map),n.set(t,r),Promise.resolve()},e.prototype.remove=function(e,t){var r=this[p$4.db].get(e);return r&&r.delete(t),Promise.resolve()},e.prototype.clear=function(e){var t=this[p$4.db].get(e);return t&&t.clear(),Promise.resolve()},e.prototype.clearAll=function(){return this[p$4.db].clear(),Promise.resolve()},e}(),STORE_KEY="session",storage$1=new InMemoryStorage,SessionStore=function(){function e(){classCallCheck(this,e)}return e.get=function(e){return storage$1.getByKey(STORE_KEY,e).catch(function(){throw new Error(`There is no item (${e}) in the session store.`)})},e.set=function(e,t){return storage$1.set(STORE_KEY,e,t)},e.remove=function(e){return storage$1.remove(STORE_KEY,e)},e}(),p$3=Object.freeze({apiURL:Symbol("apiURL")}),TextRecognizer=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?"unk":arguments[0],r=arguments.length<=1||void 0===arguments[1]||arguments[1];classCallCheck(this,e),this[p$3.apiURL]="https://api.projectoxford.ai/vision/v1.0/ocr?"+`language=${t}&detectOrientation=${r}`}return e.prototype.recognize=function(e){var t=this;return SessionStore.get("ms-api-key").then(function(r){var n=new Headers;n.append("Ocp-Apim-Subscription-Key",r);var o=new FormData;return o.append("image",e,"image.png"),fetch(t[p$3.apiURL],{method:"POST",headers:n,body:o}).then(function(e){return e.json()})})},e}(),BarcodeRecognizer=function(){function e(){classCallCheck(this,e)}return e.prototype.recognize=function(e){return new Promise(function(t,r){Quagga.decodeSingle({src:window.URL.createObjectURL(e),decoder:{readers:["code_128_reader","ean_reader","ean_8_reader","code_39_reader","code_39_vin_reader","codabar_reader","upc_reader","upc_e_reader","i2of5_reader"]}},function(e){console.log("Quagga: ",e),e?t(e):r()})})},e}(),p$2=Object.freeze({synthesizer:Symbol("synthesizer"),recognizers:Symbol("recognizers"),recognize:Symbol("recognize")}),ThingRecognizer=function(){function e(){classCallCheck(this,e),this[p$2.recognizers]=[new BarcodeRecognizer,new TextRecognizer]}return e.prototype.recognize=function(e){return this[p$2.recognize](e)},e.prototype[p$2.recognize]=function(e){var t=this,r=arguments.length<=1||void 0===arguments[1]?0:arguments[1],n=this[p$2.recognizers];return r>=n.length?Promise.reject():n[r].recognize(e).catch(function(n){return console.warn("Recognizer did not recognize image",n),t[p$2.recognize](e,r+1)})},e}(),p$6=Object.freeze({pitch:Symbol("pitch"),rate:Symbol("rate"),synthesis:Symbol("synthesis"),getPreferredVoice:Symbol("getPreferredVoice")}),SpeechSynthesizer=function(){function e(t,r){classCallCheck(this,e),this[p$6.pitch]=t,this[p$6.rate]=r,this[p$6.synthesis]=window.speechSynthesis||null,Object.seal(this)}return e.prototype.speak=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0],t=arguments.length<=1||void 0===arguments[1]?"en":arguments[1],r=this[p$6.synthesis];if(e&&r){var n=new SpeechSynthesisUtterance(e),o=this[p$6.getPreferredVoice](t);o&&(n.voice=o),n.lang=t,n.pitch=this[p$6.pitch],n.rate=this[p$6.rate],r.speak(n)}},e.prototype[p$6.getPreferredVoice]=function(e){var t=this[p$6.synthesis].getVoices();if(!t.length)return null;var r=t.filter(function(t){return t.lang.startsWith(e)}),n=r.filter(function(e){return e.name.indexOf("Female")!==-1});return n.length?n[0]:r.length?r[0]:e.startsWith("en")?null:this[p$6.getPreferredVoice]("en")},e}(),LANGUAGES=new Map([["unk","Unknown"],["ar","Arabic"],["zh-Hans","Simplified Chinese"],["zh-Hant","Traditional Chinese"],["cs","Czech"],["da","Danish"],["nl","Dutch"],["en","English"],["fi","Finnish"],["fr","French"],["de","German"],["el","Greek"],["hu","Hungarian"],["it","Italian"],["ja","Japanese"],["ko","Korean"],["nb","Norwegian"],["pl","Polish"],["pt","Portuguese"],["ru","Russian"],["es","Spanish"],["sv","Swedish"],["tr","Turkish"]]),orientation=Object.freeze({LEFT:"Left",RIGHT:"Right",UP:"Up",DOWN:"Down"}),p$7=Object.freeze({synthesizer:Symbol("synthesizer")}),UnknownThingDescriber=function(){function e(t){if(classCallCheck(this,e),!t)throw new Error("Speech Synthesizer should be provided!");this[p$7.synthesizer]=t}return e.prototype.canDescribe=function(e){var t=e.regions?e.regions.length:0;return 0!==t},e.prototype.describe=function(e,t){var r=e.regions?e.regions.length:0;if(0===r)throw new Error("Text metadata is not provided!");var n=this[p$7.synthesizer],o=void 0,i=void 0;if(t){t.context.translate(t.width/2,t.height/2),o=t.width,i=t.height;var a=e.textAngle;e.orientation===orientation.LEFT?(a-=90,o=t.height,i=t.width):e.orientation===orientation.RIGHT?(a+=90,o=t.height,i=t.width):e.orientation===orientation.DOWN&&(a+=180),t.context.rotate(a*Math.PI/180),t.context.lineWidth=3,t.context.strokeStyle="#FF0000"}1===r?n.speak("I see just one region of text."):n.speak(`I see ${r} regions of text.`);var s=e.language;s&&"unk"!==s?n.speak(`I think this is ${LANGUAGES.get(s)} language.`):n.speak("I can not recognize the language."),0===e.textAngle?n.speak("Text is perfectly aligned."):e.textAngle<10?n.speak("Text is almost perfectly aligned."):n.speak("Text is skewed.");for(var l=0;l<r;l++){var c=e.regions[l];n.speak(`Region number ${l+1} consists of `+`${c.lines.length} lines of text.`);for(var p=0;p<c.lines.length;p++){var d=c.lines[p];n.speak(`Let me read words from the line number ${p+1}:`);var u=d.words.reduce(function(e,r){var n=r.boundingBox.split(",").map(function(e){return Number(e.trim())});return t&&(t.context.rect(n[0]-o/2,n[1]-i/2,n[2],n[3]),t.context.stroke()),`${e} ${r.text}`},"");n.speak(u,s)}}},e}(),p$8=Object.freeze({synthesizer:Symbol("synthesizer")}),patterns=[/nutr(.)+(?=fact)/i,/servi(.)+(?=size)(.)+(?=cup)/i,/amoun(.)+(?=servi)/i,/calori(.)+(?=fro)(.)+(?=fat)/i,/satura(.)+(?=fat)/i,/trans(.)+(?=fat)/i],generalPattern=new RegExp("(vitamin|iron|protein|sodium|fat|sugar|fiber|calori|diet|choleste|carbo|mg|nutri|daily|calcium|potassi)","g"),NutritionFactsDescriber=function(){function e(t){if(classCallCheck(this,e),!t)throw new Error("Speech Synthesizer should be provided!");this[p$8.synthesizer]=t}return e.prototype.canDescribe=function(e){var t=e.regions?e.regions.length:0;if(0===t)return!1;var r="";for(var n of e.regions)for(var o of n.lines){var i=o.words.reduce(function(e,t){return`${e} ${t.text}`},"");for(var a of patterns)if(a.test(i))return!0;r+=i}var s=r.match(generalPattern);return s&&s.length>8},e.prototype.describe=function(e,t){var r=e.regions.length;if(0===r)throw new Error("Text metadata is not provided!");var n=this[p$8.synthesizer];n.speak("I think this is a nutrition facts label."),t&&(t.context.lineWidth=3,t.context.strokeStyle="#FF0000")},e}(),p$9=Object.freeze({synthesizer:Symbol("synthesizer")}),BarcodeDescriber=function(){function e(t){if(classCallCheck(this,e),!t)throw new Error("Speech Synthesizer should be provided!");this[p$9.synthesizer]=t}return e.prototype.canDescribe=function(e){if(e.codeResult||e.boxes&&e.boxes.length>0)return!0},e.prototype.describe=function(e,t){var r=this[p$9.synthesizer];if(r.speak("I see the barcode on this picture."),e.codeResult&&e.codeResult.code){if(e.codeResult.format){var n=e.codeResult.format.toLowerCase().replace("_"," ");n=n.replace("ean","International Article Number (or EAN)"),n=n.replace("upc","Universal Product Code (or UPC)"),r.speak(`Barcode format is ${n}`)}var o=Array.from(e.codeResult.code).reduce(function(e,t){return`${e} ${t}`},"");r.speak(`Barcode number is ${o}`)}else r.speak("But I could not recognize the numbers on it."),r.speak("Please try to make better picture.");t&&(t.context.lineWidth=3,t.context.strokeStyle="#FF0000")},e}(),p$5=Object.freeze({synthesizer:Symbol("synthesizer"),recognizers:Symbol("recognizers")}),DEFAULT_VOICE_PITCH=.8,DEFAULT_VOICE_RATE=.9,ThingDescriber=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?DEFAULT_VOICE_PITCH:arguments[0],r=arguments.length<=1||void 0===arguments[1]?DEFAULT_VOICE_RATE:arguments[1];classCallCheck(this,e);var n=this[p$5.synthesizer]=new SpeechSynthesizer(t,r);this[p$5.recognizers]=[new BarcodeDescriber(n),new NutritionFactsDescriber(n),new UnknownThingDescriber(n)]}return e.prototype.describe=function(e,t){for(var r of this[p$5.recognizers])if(r.canDescribe(e))return void r.describe(e,t);this[p$5.synthesizer].speak("Sorry! I do not recognize anything on this picture.")},e}(),LocalStorage=function(){function e(){classCallCheck(this,e)}return e.isSupported=function(){try{return!!self.localStorage&&Number.isInteger(self.localStorage.length)}catch(e){return!1}},e.prototype.getAll=function(e){var t=localStorage.getItem(e);return Promise.resolve(t?Array.from(new Map(JSON.parse(t)).values()):[])},e.prototype.getByKey=function(e,t){var r=localStorage.getItem(e),n=new Map(r?JSON.parse(r):[]);return n.has(t)?Promise.resolve(n.get(t)):Promise.reject(new Error(`There is no item (${t}) in the store (${e}).`))},e.prototype.set=function(e,t,r){var n=localStorage.getItem(e),o=new Map(n?JSON.parse(n):[]);return o.set(t,r),localStorage.setItem(e,JSON.stringify(Array.from(o.entries()))),Promise.resolve()},e.prototype.remove=function(e,t){var r=localStorage.getItem(e);if(r){var n=new Map(JSON.parse(r));n.delete(t),localStorage.setItem(e,JSON.stringify(Array.from(n.entries())))}return Promise.resolve()},e.prototype.clear=function(e){return localStorage.removeItem(e),Promise.resolve()},e.prototype.clearAll=function(){return localStorage.clear(),Promise.resolve()},e}(),p$10=Object.freeze({canvas:Symbol("canvas"),context:Symbol("context"),width:Symbol("width"),height:Symbol("height"),currentPoint:Symbol("currentPoint"),previousPoint:Symbol("previousPoint"),flag:Symbol("flag"),styleColor:Symbol("styleColor"),styleWidth:Symbol("styleWidth"),findXY:Symbol("findXY"),draw:Symbol("draw")}),Painter=function(){function e(t){var r=this;classCallCheck(this,e),this[p$10.canvas]=t,this[p$10.context]=t.getContext("2d"),this[p$10.width]=t.width,this[p$10.height]=t.height,this[p$10.styleColor]="#000",this[p$10.styleWidth]=2,this[p$10.currentPoint]={x:0,y:0},this[p$10.previousPoint]={x:0,y:0},this[p$10.flag]=!1,t.addEventListener("mousemove",function(e){return r[p$10.findXY]("move",e)}),t.addEventListener("mousedown",function(e){return r[p$10.findXY]("down",e)}),t.addEventListener("mouseup",function(e){return r[p$10.findXY]("up",e)}),t.addEventListener("mouseout",function(e){return r[p$10.findXY]("out",e)}),Object.seal(this)}return e.prototype.setStyle=function(e,t){if(!e)throw new Error("Color should a valid non-empty HEX color string!");if(!Number.isInteger(t)||t<0)throw Error("Width should a valid positive integer!");this[p$10.styleColor]=e,this[p$10.styleWidth]=t},e.prototype.clear=function(){this[p$10.context].clearRect(0,0,this[p$10.width],this[p$10.height])},e.prototype[p$10.findXY]=function(e,t){var r=t.offsetX,n=t.offsetY;if("down"===e){console.log(`e.offsetX: ${t.offsetX}, e.offsetY: ${t.offsetY}`),this[p$10.previousPoint]=this[p$10.currentPoint],this[p$10.currentPoint]={x:r,y:n},this[p$10.flag]=!0;var o=this[p$10.context];o.beginPath(),o.fillStyle=this[p$10.styleColor],o.fillRect(this[p$10.currentPoint].x,this[p$10.currentPoint].y,this[p$10.styleWidth],this[p$10.styleWidth]),o.closePath()}else"up"===e||"out"===e?this[p$10.flag]=!1:"move"===e&&this[p$10.flag]&&(this[p$10.previousPoint]=this[p$10.currentPoint],this[p$10.currentPoint]={x:r,y:n},this[p$10.draw]())},e.prototype[p$10.draw]=function(){var e=this[p$10.context];e.beginPath(),e.moveTo(this[p$10.previousPoint].x,this[p$10.previousPoint].y),e.lineTo(this[p$10.currentPoint].x,this[p$10.currentPoint].y),e.strokeStyle=this[p$10.styleColor],e.lineWidth=this[p$10.styleWidth],e.stroke(),e.closePath()},e}(),sampleActions=Object.freeze({RECOGNIZE:"RECOGNIZE",REPEAT:"REPEAT",ROTATE:"ROTATE"}),canPlayDefer=new Defer,videoManager=new VideoManager,thingDescriber=new ThingDescriber,thingRecognizer=new ThingRecognizer,storage=LocalStorage.isSupported()?new LocalStorage:new InMemoryStorage,samples=new Map,sampleIds=new Uint32Array(100);window.crypto.getRandomValues(sampleIds);var currentSampleIndex=0,apiKeyComponent=document.querySelector(".access__api-key");apiKeyComponent.addEventListener("change",function(){storage.set("access","api-key",apiKeyComponent.value),SessionStore.set("ms-api-key",apiKeyComponent.value)}),storage.getByKey("access","api-key").catch(function(e){return console.warn("Could not retrieve API key from the storage",e),""}).then(function(e){apiKeyComponent.value=e,SessionStore.set("ms-api-key",e)});var samplesListComponent=document.querySelector(".samples-list"),blobRendererComponent=document.querySelector(".blob__renderer"),blobLoaderComponent=document.querySelector(".blob__loader");samplesListComponent.addEventListener("click",function(e){if(!apiKeyComponent.value)return void alert("Please provide Microsoft Vision API key.");var t=e.target.dataset.sampleId;if("BUTTON"===e.target.nodeName.toUpperCase()&&t){var r=samples.get(Number.parseInt(t)),n=e.target.dataset.kind;n===sampleActions.RECOGNIZE?thingRecognizer.recognize(r.image).then(function(e){console.log("Success: %o",e),r.text=e,samples.set(r.id,r);var t=document.getElementById(r.id);return t.classList.add("sample__container--recognized"),getSampleCanvas(r).then(function(t){thingDescriber.describe(e,t),blobRendererComponent.toBlob(function(e){document.getElementById(r.id).querySelector("img").src=window.URL.createObjectURL(e)})})}).catch(function(e){console.error("Failure %o",e)}):n===sampleActions.REPEAT&&thingDescriber.describe(r.text)}});var videoPreviewComponent=document.querySelector(".video__preview"),context=blobRendererComponent.getContext("2d");context.fillStyle="#aaa",context.fillRect(0,0,blobRendererComponent.width,blobRendererComponent.height),videoManager.getMediaStream().then(function(e){videoPreviewComponent.src=window.URL.createObjectURL(e),videoPreviewComponent.addEventListener("loadedmetadata",function(){videoPreviewComponent.play(),canPlayDefer.resolve({width:videoPreviewComponent.videoWidth,height:videoPreviewComponent.videoHeight})},!1)}).catch(function(e){canPlayDefer.reject(e)});var shotButton=document.querySelector(".video__shot-button");shotButton.setAttribute("disabled","disabled"),shotButton.addEventListener("click",function(){var e=videoPreviewComponent.clientWidth,t=videoPreviewComponent.clientHeight;blobRendererComponent.setAttribute("width",e),blobRendererComponent.setAttribute("height",t),blobRendererComponent.getContext("2d").drawImage(videoPreviewComponent,0,0,Number(e),Number(t)),blobRendererComponent.toBlob(function(e){addSample(e)})}),canPlayDefer.promise.then(function(){shotButton.removeAttribute("disabled")});var urlProviderURL=document.querySelector(".sample-url-provider__url"),urlProviderSubmit=document.querySelector(".sample-url-provider__submit");urlProviderSubmit.addEventListener("click",function(){var e=urlProviderURL.value;return e?void addSampleFromURL(e):void alert("Please provide a valid image URL!")});var localFileProviderPath=document.querySelector(".local-file-provider__path"),localFileProviderUpload=document.querySelector(".local-file-provider__upload");localFileProviderPath.addEventListener("change",function(e){for(var t of e.target.files)addSample(t)}),localFileProviderUpload.addEventListener("click",function(){localFileProviderPath.click()});var manualSampleCanvas=document.querySelector(".manual-sample-provider__canvas"),manualSampleColorPicker=document.querySelector(".manual-sample-provider__color-picker"),manualSampleWidth=document.querySelector(".manual-sample-provider__width"),manualSampleClearButton=document.querySelector(".manual-sample-provider__clear-button"),manualSampleSubmit=document.querySelector(".manual-sample-provider__submit"),painter=new Painter(manualSampleCanvas);manualSampleColorPicker.addEventListener("change",function(){painter.setStyle(manualSampleColorPicker.value,Number(manualSampleWidth.value))}),manualSampleWidth.addEventListener("change",function(){painter.setStyle(manualSampleColorPicker.value,Number(manualSampleWidth.value))}),manualSampleClearButton.addEventListener("click",function(){painter.clear()}),manualSampleSubmit.addEventListener("click",function(){manualSampleCanvas.toBlob(function(e){return addSample(e)})}),window.addEventListener("hashchange",function(){addSampleFromHash()}),addSampleFromHash();

//# sourceMappingURL=app.js.map
