function addSample(e){var t=sampleIds[currentSampleIndex++],n=document.createElement("div");n.classList="sample__container",n.id=t;var r=document.createElement("img");r.classList="sample__preview",r.src=window.URL.createObjectURL(e);var o=document.createElement("button");o.type="button",o.textContent="Recognize",o.classList="sample__recognize-button action-button",o.dataset.sampleId=t,o.dataset.kind=sampleActions.RECOGNIZE;var i=document.createElement("button");i.type="button",i.textContent="Repeat text",i.classList="sample__repeat-button action-button",i.dataset.sampleId=t,i.dataset.kind=sampleActions.REPEAT,n.appendChild(r),n.appendChild(o),n.appendChild(i),samplesListComponent.appendChild(n),samples.set(t,{id:t,image:e,text:null})}function getSampleCanvas(e){var t=new Defer;return blobLoaderComponent.src=window.URL.createObjectURL(e.image),blobLoaderComponent.onload=function(){var e=blobRendererComponent.getContext("2d");e.clearRect(0,0,Number(blobRendererComponent.getAttribute("width")),Number(blobRendererComponent.getAttribute("height"))),blobRendererComponent.setAttribute("width",blobLoaderComponent.width),blobRendererComponent.setAttribute("height",blobLoaderComponent.height),e.drawImage(blobLoaderComponent,0,0,blobLoaderComponent.width,blobLoaderComponent.height),t.resolve({context:e,width:blobLoaderComponent.width,height:blobLoaderComponent.height})},blobLoaderComponent.onerror=function(e){return t.reject(e)},t.promise}function addSampleFromURL(e){return fetch(e).catch(function(t){console.warn("Can not load image directly, trying through the proxy: ",t);var n=`https://recognizer-ocr-proxy.herokuapp.com/?${e}`,r=new Headers;return r.append("Target-URL",e),fetch(n,{headers:r})}).then(function(e){return e.blob()}).then(function(e){addSample(e)}).catch(function(e){console.error("Failed to add sample from URL: ",e),alert("Failed to add sample! See log for more details...")})}function addSampleFromHash(){!location.hash||location.hash.length<2||addSampleFromURL(location.hash.slice(1).trim())}var classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),p=Object.freeze({promise:Symbol("promise"),resolve:Symbol("resolve"),reject:Symbol("reject")}),Defer=function(){function e(){var t=this;classCallCheck(this,e),this[p.promise]=new Promise(function(e,n){t[p.resolve]=e,t[p.reject]=n}),Object.freeze(this)}return e.prototype.resolve=function(e){this[p.resolve](e)},e.prototype.reject=function(e){this[p.reject](e)},createClass(e,[{key:"promise",get:function(){return this[p.promise]}}]),e}(),p$1=Object.freeze({getUserMediaOld:Symbol("getUserMediaOld")}),VideoManager=function(){function e(){classCallCheck(this,e)}return e.prototype.getMediaStream=function(){var e=arguments.length<=0||void 0===arguments[0]||arguments[0],t=!(arguments.length<=1||void 0===arguments[1])&&arguments[1];return void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=this[p$1.getUserMediaOld]),navigator.mediaDevices.getUserMedia({audio:t,video:e}).then(function(e){return console.log("[VideoManager]: Media stream is available."),e}).catch(function(e){throw console.error("[VideoManager]: Media stream is not available.",e),e})},e.prototype[p$1.getUserMediaOld]=function(e){var t=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise(function(n,r){t.call(navigator,e,n,r)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))},e}(),p$2=Object.freeze({apiURL:Symbol("apiURL"),apiKey:Symbol("apiKey")}),TextRecognizer=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?"":arguments[0],n=arguments.length<=1||void 0===arguments[1]?"unk":arguments[1],r=arguments.length<=2||void 0===arguments[2]||arguments[2];classCallCheck(this,e),this[p$2.apiURL]="https://api.projectoxford.ai/vision/v1.0/ocr?"+`language=${n}&detectOrientation=${r}`,this[p$2.apiKey]=t}return e.prototype.recognize=function(e){var t=new Headers;t.append("Ocp-Apim-Subscription-Key",this[p$2.apiKey]);var n=new FormData;return n.append("image",e,"image.png"),fetch(this[p$2.apiURL],{method:"POST",headers:t,body:n}).then(function(e){return e.json()})},e.prototype.setAPIKey=function(e){this[p$2.apiKey]=e},e}(),p$4=Object.freeze({pitch:Symbol("pitch"),rate:Symbol("rate"),synthesis:Symbol("synthesis"),getPreferredVoice:Symbol("getPreferredVoice")}),SpeechSynthesizer=function(){function e(t,n){classCallCheck(this,e),this[p$4.pitch]=t,this[p$4.rate]=n,this[p$4.synthesis]=window.speechSynthesis||null,Object.seal(this)}return e.prototype.speak=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0],t=arguments.length<=1||void 0===arguments[1]?"en":arguments[1],n=this[p$4.synthesis];if(e&&n){var r=new SpeechSynthesisUtterance(e),o=this[p$4.getPreferredVoice](t);o&&(r.voice=o),r.lang=t,r.pitch=this[p$4.pitch],r.rate=this[p$4.rate],n.speak(r)}},e.prototype[p$4.getPreferredVoice]=function(e){var t=this[p$4.synthesis].getVoices();if(!t.length)return null;var n=t.filter(function(t){return t.lang.startsWith(e)}),r=n.filter(function(e){return e.name.indexOf("Female")!==-1});return r.length?r[0]:n.length?n[0]:e.startsWith("en")?null:this[p$4.getPreferredVoice]("en")},e}(),LANGUAGES=new Map([["unk","Unknown"],["ar","Arabic"],["zh-Hans","Simplified Chinese"],["zh-Hant","Traditional Chinese"],["cs","Czech"],["da","Danish"],["nl","Dutch"],["en","English"],["fi","Finnish"],["fr","French"],["de","German"],["el","Greek"],["hu","Hungarian"],["it","Italian"],["ja","Japanese"],["ko","Korean"],["nb","Norwegian"],["pl","Polish"],["pt","Portuguese"],["ru","Russian"],["es","Spanish"],["sv","Swedish"],["tr","Turkish"]]),orientation=Object.freeze({LEFT:"Left",RIGHT:"Right",UP:"Up",DOWN:"Down"}),p$5=Object.freeze({synthesizer:Symbol("synthesizer")}),UnknonwThingRecognizer=function(){function e(t){if(classCallCheck(this,e),!t)throw new Error("Speech Synthesizer should be provided!");this[p$5.synthesizer]=t}return e.prototype.canDescribe=function(){return!0},e.prototype.describe=function(e,t){var n=e.regions.length;if(0===n)throw new Error("Text metadata is not provided!");var r=this[p$5.synthesizer],o=void 0,i=void 0;if(t){t.context.translate(t.width/2,t.height/2),o=t.width,i=t.height;var a=e.textAngle;e.orientation===orientation.LEFT?(a-=90,o=t.height,i=t.width):e.orientation===orientation.RIGHT?(a+=90,o=t.height,i=t.width):e.orientation===orientation.DOWN&&(a+=180),t.context.rotate(a*Math.PI/180),t.context.lineWidth=3,t.context.strokeStyle="#FF0000"}1===n?r.speak("I see just one region of text."):r.speak(`I see ${n} regions of text.`);var s=e.language;s&&"unk"!==s?r.speak(`I think this is ${LANGUAGES.get(s)} language.`):r.speak("I can not recognize the language."),0===e.textAngle?r.speak("Text is perfectly aligned."):e.textAngle<10?r.speak("Text is almost perfectly aligned."):r.speak("Text is skewed.");for(var l=0;l<n;l++){var c=e.regions[l];r.speak(`Region number ${l+1} consists of `+`${c.lines.length} lines of text.`);for(var p=0;p<c.lines.length;p++){var d=c.lines[p];r.speak(`Let me read words from the line number ${p+1}:`);var u=d.words.reduce(function(e,n){var r=n.boundingBox.split(",").map(function(e){return Number(e.trim())});return t&&(t.context.rect(r[0]-o/2,r[1]-i/2,r[2],r[3]),t.context.stroke()),`${e} ${n.text}`},"");r.speak(u,s)}}},e}(),p$3=Object.freeze({synthesizer:Symbol("synthesizer"),describers:Symbol("describers")}),DEFAULT_VOICE_PITCH=.8,DEFAULT_VOICE_RATE=.9,ThingDescriber=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?DEFAULT_VOICE_PITCH:arguments[0],n=arguments.length<=1||void 0===arguments[1]?DEFAULT_VOICE_RATE:arguments[1];classCallCheck(this,e),this[p$3.synthesizer]=new SpeechSynthesizer(t,n),this[p$3.describers]=[new UnknonwThingRecognizer(this[p$3.synthesizer])]}return e.prototype.describe=function(e,t){if(0===e.regions.length)return void this[p$3.synthesizer].speak("Sorry! I did not recognize any text.");for(var n of this[p$3.describers])if(n.canDescribe(e)){n.describe(e,t);break}},e}(),LocalStorage=function(){function e(){classCallCheck(this,e)}return e.isSupported=function(){try{return!!self.localStorage&&Number.isInteger(self.localStorage.length)}catch(e){return!1}},e.prototype.getAll=function(e){var t=localStorage.getItem(e);return Promise.resolve(t?Array.from(new Map(JSON.parse(t)).values()):[])},e.prototype.getByKey=function(e,t){var n=localStorage.getItem(e),r=new Map(n?JSON.parse(n):[]);return r.has(t)?Promise.resolve(r.get(t)):Promise.reject(new Error(`There is no item (${t}) in the store (${e}).`))},e.prototype.set=function(e,t,n){var r=localStorage.getItem(e),o=new Map(r?JSON.parse(r):[]);return o.set(t,n),localStorage.setItem(e,JSON.stringify(Array.from(o.entries()))),Promise.resolve()},e.prototype.remove=function(e,t){var n=localStorage.getItem(e);if(n){var r=new Map(JSON.parse(n));r.delete(t),localStorage.setItem(e,JSON.stringify(Array.from(r.entries())))}return Promise.resolve()},e.prototype.clear=function(e){return localStorage.removeItem(e),Promise.resolve()},e.prototype.clearAll=function(){return localStorage.clear(),Promise.resolve()},e}(),p$6=Object.freeze({db:Symbol("db")}),InMemoryStorage=function(){function e(){classCallCheck(this,e),this[p$6.db]=new Map}return e.prototype.getAll=function(e){var t=this[p$6.db].get(e);return Promise.resolve(t?Array.from(t.values()):[])},e.prototype.getByKey=function(e,t){var n=this[p$6.db].get(e);return!n||n.has(t)?Promise.reject(new Error(`There is no item (${t}) in the store (${e}).`)):Promise.resolve(n.get(t))},e.prototype.set=function(e,t,n){var r=this[p$6.db].get(e);return r||this[p$6.db].set(e,r=new Map),r.set(t,n),Promise.resolve()},e.prototype.remove=function(e,t){var n=this[p$6.db].get(e);return n&&n.delete(t),Promise.resolve()},e.prototype.clear=function(e){var t=this[p$6.db].get(e);return t&&t.clear(),Promise.resolve()},e.prototype.clearAll=function(){return this[p$6.db].clear(),Promise.resolve()},e}(),p$7=Object.freeze({canvas:Symbol("canvas"),context:Symbol("context"),width:Symbol("width"),height:Symbol("height"),currentPoint:Symbol("currentPoint"),previousPoint:Symbol("previousPoint"),flag:Symbol("flag"),styleColor:Symbol("styleColor"),styleWidth:Symbol("styleWidth"),findXY:Symbol("findXY"),draw:Symbol("draw")}),Painter=function(){function e(t){var n=this;classCallCheck(this,e),this[p$7.canvas]=t,this[p$7.context]=t.getContext("2d"),this[p$7.width]=t.width,this[p$7.height]=t.height,this[p$7.styleColor]="#000",this[p$7.styleWidth]=2,this[p$7.currentPoint]={x:0,y:0},this[p$7.previousPoint]={x:0,y:0},this[p$7.flag]=!1,t.addEventListener("mousemove",function(e){return n[p$7.findXY]("move",e)}),t.addEventListener("mousedown",function(e){return n[p$7.findXY]("down",e)}),t.addEventListener("mouseup",function(e){return n[p$7.findXY]("up",e)}),t.addEventListener("mouseout",function(e){return n[p$7.findXY]("out",e)}),Object.seal(this)}return e.prototype.setStyle=function(e,t){if(!e)throw new Error("Color should a valid non-empty HEX color string!");if(!Number.isInteger(t)||t<0)throw Error("Width should a valid positive integer!");this[p$7.styleColor]=e,this[p$7.styleWidth]=t},e.prototype.clear=function(){this[p$7.context].clearRect(0,0,this[p$7.width],this[p$7.height])},e.prototype[p$7.findXY]=function(e,t){var n=t.offsetX,r=t.offsetY;if("down"===e){console.log(`e.offsetX: ${t.offsetX}, e.offsetY: ${t.offsetY}`),this[p$7.previousPoint]=this[p$7.currentPoint],this[p$7.currentPoint]={x:n,y:r},this[p$7.flag]=!0;var o=this[p$7.context];o.beginPath(),o.fillStyle=this[p$7.styleColor],o.fillRect(this[p$7.currentPoint].x,this[p$7.currentPoint].y,this[p$7.styleWidth],this[p$7.styleWidth]),o.closePath()}else"up"===e||"out"===e?this[p$7.flag]=!1:"move"===e&&this[p$7.flag]&&(this[p$7.previousPoint]=this[p$7.currentPoint],this[p$7.currentPoint]={x:n,y:r},this[p$7.draw]())},e.prototype[p$7.draw]=function(){var e=this[p$7.context];e.beginPath(),e.moveTo(this[p$7.previousPoint].x,this[p$7.previousPoint].y),e.lineTo(this[p$7.currentPoint].x,this[p$7.currentPoint].y),e.strokeStyle=this[p$7.styleColor],e.lineWidth=this[p$7.styleWidth],e.stroke(),e.closePath()},e}(),sampleActions=Object.freeze({RECOGNIZE:"RECOGNIZE",REPEAT:"REPEAT",ROTATE:"ROTATE"}),canPlayDefer=new Defer,videoManager=new VideoManager,thingDescriber=new ThingDescriber,textRecognizer=new TextRecognizer,storage=LocalStorage.isSupported()?new LocalStorage:new InMemoryStorage,samples=new Map,sampleIds=new Uint32Array(100);window.crypto.getRandomValues(sampleIds);var currentSampleIndex=0,apiKeyComponent=document.querySelector(".access__api-key");apiKeyComponent.addEventListener("change",function(){storage.set("access","api-key",apiKeyComponent.value),textRecognizer.setAPIKey(apiKeyComponent.value)}),storage.getByKey("access","api-key").catch(function(e){return console.warn("Could not retrieve API key from the storage",e),""}).then(function(e){apiKeyComponent.value=e,textRecognizer.setAPIKey(e)});var samplesListComponent=document.querySelector(".samples-list"),blobRendererComponent=document.querySelector(".blob__renderer"),blobLoaderComponent=document.querySelector(".blob__loader");samplesListComponent.addEventListener("click",function(e){if(!apiKeyComponent.value)return void alert("Please provide Microsoft Vision API key.");var t=e.target.dataset.sampleId;if("BUTTON"===e.target.nodeName.toUpperCase()&&t){var n=samples.get(Number.parseInt(t)),r=e.target.dataset.kind;r===sampleActions.RECOGNIZE?textRecognizer.recognize(n.image).then(function(e){console.log("Success: %o",e),n.text=e,samples.set(n.id,n);var t=document.getElementById(n.id);return t.classList.add("sample__container--recognized"),getSampleCanvas(n).then(function(t){thingDescriber.describe(e,t),blobRendererComponent.toBlob(function(e){document.getElementById(n.id).querySelector("img").src=window.URL.createObjectURL(e)})})}).catch(function(e){console.error("Failure %o",e)}):r===sampleActions.REPEAT&&thingDescriber.describe(n.text)}});var videoPreviewComponent=document.querySelector(".video__preview"),context=blobRendererComponent.getContext("2d");context.fillStyle="#aaa",context.fillRect(0,0,blobRendererComponent.width,blobRendererComponent.height),videoManager.getMediaStream().then(function(e){videoPreviewComponent.src=window.URL.createObjectURL(e),videoPreviewComponent.addEventListener("loadedmetadata",function(){videoPreviewComponent.play(),canPlayDefer.resolve({width:videoPreviewComponent.videoWidth,height:videoPreviewComponent.videoHeight})},!1)}).catch(function(e){canPlayDefer.reject(e)});var shotButton=document.querySelector(".video__shot-button");shotButton.setAttribute("disabled","disabled"),shotButton.addEventListener("click",function(){var e=videoPreviewComponent.clientWidth,t=videoPreviewComponent.clientHeight;blobRendererComponent.setAttribute("width",e),blobRendererComponent.setAttribute("height",t),blobRendererComponent.getContext("2d").drawImage(videoPreviewComponent,0,0,Number(e),Number(t)),blobRendererComponent.toBlob(function(e){addSample(e)})}),canPlayDefer.promise.then(function(){shotButton.removeAttribute("disabled")});var urlProviderURL=document.querySelector(".sample-url-provider__url"),urlProviderSubmit=document.querySelector(".sample-url-provider__submit");urlProviderSubmit.addEventListener("click",function(){var e=urlProviderURL.value;return e?void addSampleFromURL(e):void alert("Please provide a valid image URL!")});var localFileProviderPath=document.querySelector(".local-file-provider__path"),localFileProviderUpload=document.querySelector(".local-file-provider__upload");localFileProviderPath.addEventListener("change",function(e){for(var t of e.target.files)addSample(t)}),localFileProviderUpload.addEventListener("click",function(){localFileProviderPath.click()});var manualSampleCanvas=document.querySelector(".manual-sample-provider__canvas"),manualSampleColorPicker=document.querySelector(".manual-sample-provider__color-picker"),manualSampleWidth=document.querySelector(".manual-sample-provider__width"),manualSampleClearButton=document.querySelector(".manual-sample-provider__clear-button"),manualSampleSubmit=document.querySelector(".manual-sample-provider__submit"),painter=new Painter(manualSampleCanvas);manualSampleColorPicker.addEventListener("change",function(){painter.setStyle(manualSampleColorPicker.value,Number(manualSampleWidth.value))}),manualSampleWidth.addEventListener("change",function(){painter.setStyle(manualSampleColorPicker.value,Number(manualSampleWidth.value))}),manualSampleClearButton.addEventListener("click",function(){painter.clear()}),manualSampleSubmit.addEventListener("click",function(){manualSampleCanvas.toBlob(function(e){return addSample(e)})}),window.addEventListener("hashchange",function(){addSampleFromHash()}),addSampleFromHash();

//# sourceMappingURL=app.js.map
